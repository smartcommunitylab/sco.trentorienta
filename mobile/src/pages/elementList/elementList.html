<ion-header>
    <ion-navbar color="primary">
        <button ion-button menuToggle>
            <ion-icon name="menu"></ion-icon>
        </button>
        <ion-title>
            {{title}}        
        </ion-title>
        <ion-buttons end>
            <button ion-button *ngIf="view=='calendario' && hasDate" (click)='removeDate()'>
                <ion-label>Annulla</ion-label>
                <ion-icon name="close-circle"></ion-icon>
            </button>
            
            <button ion-button icon-right *ngIf="view=='calendario'" (click)="picker.open()"> 
                <ion-datetime #picker style="display:none" pickerFormat="DD.MM.YYYY" 
                               min='{{currDate}}' max='2050' [(ngModel)]="myDate" (ionChange)="scrolling(myDate)">
                </ion-datetime>
                <ion-icon name="calendar"></ion-icon>
            </button>
            
            <button ion-button *ngIf="view=='lista' && isHome" (click)='toggleFilters()'>
                <ion-icon name="ios-funnel"></ion-icon>
            </button>
            
            <button ion-button *ngIf="view=='lista' && isSor" (click)='addFav(source)'>
                <ion-icon *ngIf="source.fav" name="star"></ion-icon>
                <ion-icon *ngIf="!source.fav" name="star-outline"></ion-icon>
            </button>
            
            <button ion-button *ngIf="view=='lista' && isTheme" (click)='addFav(theme)'>
                <ion-icon *ngIf="theme.fav" name="star"></ion-icon>
                <ion-icon *ngIf="!theme.fav" name="star-outline"></ion-icon>
            </button>

            <button ion-button *ngIf="view=='lista'" (click)='toggleSearch()'>
                <ion-icon *ngIf="!searching" name="search"></ion-icon>
                <ion-icon *ngIf="searching" name="close-circle"></ion-icon>
            </button>
        </ion-buttons>
    </ion-navbar>
</ion-header>


<ion-content>
    <div [ngSwitch]="view" style="height: 100%; width: 100%">        
        <ion-searchbar #searchBox *ngIf="searching" (ionInput)="search(searchBox.value)"></ion-searchbar>
        
        <div *ngSwitchCase="'lista'" style="height: 100%; width: 100%">
            <div *ngIf="mainEvents.length==0 && charged" class="error"> 
                <h2>Non sono stati trovati eventi corrispondenti ai tuoi filtri</h2>
                <!-- <button ion-button (click)="goBack()">
                    OK
                </button> -->
            </div>
            <ion-list mode="md">
                <ion-item *ngFor="let event of mainEvents" (click)="onSelect(event)">
                    <ion-thumbnail item-start>
                        <img *ngIf="event.image" src={{event.image}}>
                        <img *ngIf="!event.image" src='assets/icon/comune.jpeg'>
                    </ion-thumbnail>
                    <span *ngIf="tagging" class="tags">{{event.tags}}</span>
                    <h2>{{event.title}}</h2>
                    <p class="pubb">Pubblicato il: <span class="crea">{{event.createdDate | date: 'dd/MM/yyyy'}}</span></p>
                </ion-item>
            </ion-list>
            <ion-infinite-scroll *ngIf="enabled" (ionInfinite)="doInfinite($event)">
                <ion-infinite-scroll-content 
                    loadingSpinner = "bubbles" 
                    loadingText = "Caricamento">
                </ion-infinite-scroll-content>
            </ion-infinite-scroll>
        </div>    

        <div *ngSwitchCase="'mappa'" style="height: 100%; width: 100%">
            <div leaflet style="height: 100%; width: 100%"
                [leafletOptions]="options"
                [leafletLayers]="layers"
                (leafletMapReady)="onMapReady($event)" >
            </div>
        </div>

        <div *ngSwitchCase="'calendario'">
            <div *ngIf="mainEvents.length == 0 && charged" class="error"> 
                <h2>Non sono stati trovati eventi corrispondenti ai tuoi filtri</h2>
                <button ion-button (click)="goBack()">
                    OK
                </button>
            </div>
            <ion-list>
                <ion-item-divider *ngFor="let key of calendarEvents | ObjNgFor" color="date" mode="md">
                    {{key | date: 'dd.MM.yyyy'}}
                    <ion-item *ngFor="let event of calendarEvents[key]" (click)="onSelect(event)" mode="md" class="noborder">
                        <ion-thumbnail item-start>
                            <img *ngIf="event.image" src={{event.image}}>
                            <img *ngIf="!event.image" src='assets/icon/comune.jpeg'>
                        </ion-thumbnail>
                        <h2>{{event.title}}</h2>
                        <span class="grey">Pubblicato il:</span> {{event.createdDate | date: 'dd/MM/yyyy'}}
                    </ion-item>
                </ion-item-divider>  
            </ion-list>
            <ion-infinite-scroll *ngIf="!hasDate" (ionInfinite)="doInfiniteCal($event)">
                <ion-infinite-scroll-content 
                    loadingSpinner = "bubbles" 
                    loadingText = "Caricamento">
                </ion-infinite-scroll-content>
            </ion-infinite-scroll>
            <ion-infinite-scroll *ngIf="hasDate" (ionInfinite)="doInfiniteDate($event, myDate)">
                <ion-infinite-scroll-content 
                    loadingSpinner = "bubbles" 
                    loadingText = "Caricamento">
                </ion-infinite-scroll-content>
            </ion-infinite-scroll>
        </div>
    </div>
</ion-content>

<ion-footer>
    <ion-toolbar no-border-top color="primary">
        <ion-segment [(ngModel)]="view" (ionChange)="switchSegment(view)"  color="light" mode="md">
            <ion-segment-button value="lista">
                <ion-icon name="md-list"></ion-icon>
            </ion-segment-button>
            <ion-segment-button value="mappa">
                <ion-icon name="ios-map"></ion-icon>
            </ion-segment-button>
            <ion-segment-button value="calendario" (click)='loadCalendar()'>
                <ion-icon name="md-calendar"></ion-icon>
            </ion-segment-button>
        </ion-segment>
    </ion-toolbar>
</ion-footer>